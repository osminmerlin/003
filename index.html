<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>烟迹终结者</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#34C759">
  <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==">
  <style>
    :root{
      --primary:#34C759;
      --bg:#F2F7F4;
      --card:#fff;
      --text:#1C1C1E;
      --sub:#8E8E93;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#000;
        --card:#1C1C1E;
        --text:#fff;
        --sub:#8E8E93;
      }
    }
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,Arial,sans-serif}
    body{background:var(--bg);color:var(--text)}
    .screen{min-height:100vh;display:flex;flex-direction:column;padding:32px 24px 40px}
    h1{font-size:28px;font-weight:600;margin-bottom:24px}
    .card{width:100%;background:var(--card);border-radius:24px;padding:24px;box-shadow:0 8px 24px rgba(0,0,0,.06);margin-bottom:24px}
    .ring{position:relative;width:180px;height:180px;margin:0 auto 24px}
    .ring svg{transform:rotate(-90deg)}
    .ring-num{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:48px;font-weight:600}
    .btn{width:100%;height:56px;border-radius:16px;border:0;background:var(--primary);color:#fff;font-size:18px;font-weight:600;box-shadow:0 4px 12px rgba(52,199,89,.3)}
    .btn:active{opacity:.8}
    .flex{display:flex;justify-content:space-between;align-items:center}
    .save-tag{font-size:14px;color:var(--sub)}
    .chart-box{height:120px;position:relative}
    .poster-btn{margin-top:12px;background:var(--sub);color:#fff}
    canvas{width:100%;height:100%}
    .hidden{display:none}
  </style>
</head>
<body>
  <div id="app" class="screen">
    <h1>掌控今日</h1>
    <div class="card">
      <div class="ring">
        <svg width="180" height="180">
          <circle cx="90" cy="90" r="80" stroke="#E5E5EA" stroke-width="12" fill="none"/>
          <circle id="progress" cx="90" cy="90" r="80" stroke="#34C759" stroke-width="12" fill="none" stroke-dasharray="502.4" stroke-dashoffset="502.4" stroke-linecap="round"/>
        </svg>
        <div class="ring-num"><span id="today">0</span></div>
      </div>
      <button class="btn" onclick="addOne()">记录一支</button>
      <div class="flex" style="margin-top:16px">
        <span class="save-tag">过去均值 <b id="avg">20</b></span>
        <span class="save-tag">节省 ¥<b id="save">0.00</b></span>
      </div>
    </div>
    <div class="card">
      <div class="flex" style="margin-bottom:12px">
        <div style="font-size:16px;font-weight:600">身体恢复时间轴</div>
        <div id="recoverText" style="font-size:14px;color:var(--sub)">8h</div>
      </div>
      <div class="chart-box"><canvas id="recoverCanvas"></canvas></div>
    </div>
    <div class="card">
      <div class="flex" style="margin-bottom:12px">
        <div style="font-size:16px;font-weight:600">7日趋势</div>
        <div style="font-size:14px;color:var(--sub)" onclick="toggleChart()">左滑看30日</div>
      </div>
      <div class="chart-box"><canvas id="trendCanvas"></canvas></div>
    </div>
    <button class="btn poster-btn" onclick="genPoster()">生成月度海报</button>
  </div>

  <script>
    // 工具
    const $ = q => document.querySelector(q);
    const idb = window.indexedDB.open('smokeDB',1);
    let db;
    idb.onsuccess = () => { db = idb.result; loadAll(); };
    idb.onupgradeneeded = () => {
      db = idb.result;
      if(!db.objectStoreNames.contains('records')) db.createObjectStore('records',{keyPath:'id',autoIncrement:true});
    };
    function save(rec){ const tx = db.transaction('records','readwrite'); tx.objectStore('records').put(rec); }
    function loadAll(){
      const tx = db.transaction('records','readonly');
      const store = tx.objectStore('records');
      const req = store.getAll();
      req.onsuccess = () => { window.allRecords = req.result; updateUI(); };
    }

    // 状态
    const avg = 20; // 过去均值
    let today = 0;
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();

    function addOne(){
      today += 1;
      save({date:new Date().toISOString().slice(0,10), count:today});
      updateUI();
    }
    function updateUI(){
      $('#today').textContent = today;
      const save = Math.max(0, avg - today) * (25/20); // 假设每盒25元20支
      $('#save').textContent = save.toFixed(2);
      const pct = avg ? (today/avg)*100 : 0;
      const offset = 502.4 - (502.4 * pct / 100);
      $('#progress').style.strokeDashoffset = offset;
      drawRecover();
      drawTrend();
    }
    function drawRecover(){
      const canvas = $('#recoverCanvas');
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.offsetWidth * devicePixelRatio;
      canvas.height = canvas.offsetHeight * devicePixelRatio;
      ctx.scale(devicePixelRatio, devicePixelRatio);
      const w = canvas.offsetWidth, h = canvas.offsetHeight;
      ctx.clearRect(0,0,w,h);
      const milestones = [8,48,72,336,720,2160]; // h
      const labels = ['8h','48h','72h','2周','1月','3月'];
      const barW = w / milestones.length - 8;
      const now = today <= avg ? Math.min(5, Math.floor((avg-today)/avg*6)) : -1;
      ctx.fillStyle = '#34C759';
      for(let i=0;i<=now;i++){
        ctx.fillRect(i*(barW+8), h-20, barW, 16);
        ctx.fillStyle = '#8E8E93';
        ctx.fillText(labels[i], i*(barW+8), h-4);
      }
      $('#recoverText').textContent = now>=0?labels[now]:'—';
    }
    function drawTrend(){
      const canvas = $('#trendCanvas');
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.offsetWidth * devicePixelRatio;
      canvas.height = canvas.offsetHeight * devicePixelRatio;
      ctx.scale(devicePixelRatio, devicePixelRatio);
      const w = canvas.offsetWidth, h = canvas.offsetHeight;
      ctx.clearRect(0,0,w,h);
      const days = window.allRecords ? window.allRecords.slice(-7) : [];
      const max = Math.max(avg, ...days.map(d=>d.count));
      const pad = 16, step = (w - 2*pad) / Math.max(1, days.length-1);
      ctx.strokeStyle = '#34C759'; ctx.lineWidth = 3; ctx.lineCap = 'round';
      ctx.beginPath();
      days.forEach((d,i)=>{
        const x = pad + i*step;
        const y = h - pad - (d.count/max)*(h-2*pad);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();
      // 均线
      ctx.strokeStyle = '#8E8E93'; ctx.setLineDash([4,4]);
      const yAvg = h - pad - (avg/max)*(h-2*pad);
      ctx.beginPath(); ctx.moveTo(pad,yAvg); ctx.lineTo(w-pad,yAvg); ctx.stroke();
      ctx.setLineDash([]);
    }
    function toggleChart(){
      // 简易切换提示，后续可扩展30日
      alert('30日视图开发中，先继续掌控今日吧！');
    }
    function genPoster(){
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const dpr = devicePixelRatio;
      canvas.width = 1080 * dpr; canvas.height = 1080 * dpr;
      ctx.scale(dpr,dpr);
      // 背景
      ctx.fillStyle = '#F2F7F4'; ctx.fillRect(0,0,1080,1080);
      // 标题
      ctx.fillStyle = '#1C1C1E'; ctx.font = 'bold 72px -apple-system'; ctx.textAlign = 'center';
      ctx.fillText('烟迹终结者',540,200);
      // 本月节省
      const monthSave = Math.max(0, avg - today) * (25/20); // 伪
      ctx.font = '48px -apple-system'; ctx.fillStyle = '#34C759';
      ctx.fillText(`本月节省 ¥${monthSave.toFixed(2)}`,540,400);
      // 身体恢复
      ctx.fillStyle = '#8E8E93'; ctx.font = '36px -apple-system';
      ctx.fillText('身体恢复进度 72%',540,600);
      // 二维码占位
      ctx.fillStyle = '#000'; ctx.fillRect(440,800,200,200);
      ctx.fillStyle = '#fff'; ctx.fillText('扫码查看',540,940);
      // 导出
      canvas.toBlob(blob=>{
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='月度海报.jpg'; a.click();
      },'image/jpeg',0.9);
    }

    // PWA & SW
    if('serviceWorker' in navigator){
      const sw = `self.addEventListener('install',e=>e.waitUntil(caches.open('v1').then(c=>c.addAll(['/']))))`;
      const blob = new Blob([sw],{type:'application/javascript'});
      const url = URL.createObjectURL(blob);
      navigator.serviceWorker.register(url);
    }
    // 启动
    updateUI();
  </script>
</body>
</html>